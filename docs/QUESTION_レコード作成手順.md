# Question（問い合わせ）レコード作成 — 手順書

問い合わせLWCからSandboxに問い合わせレコードを作成するための、ローカルでの準備からSandbox内の設定までの手順です。

---

## 前提

- Salesforce CLI（sf / sfdx）がインストール済みであること
- Sandbox への接続が済んでいること（`sf org list` で確認可能）

---

## 1. ローカルでデプロイする

### 1-1. Sandbox に接続する

```bash
# 既存の接続を確認
sf org list

# 未接続の場合は Sandbox にログイン（ブラウザが開きます）
sf org login web --alias MySandbox --instance-url https://test.salesforce.com
```

### 1-2. ソースをデプロイする

プロジェクトルート（`practiceLWC`）で実行します。

```bash
# すべてのメタデータをデプロイ
sf project deploy start --target-org MySandbox
```

デプロイされる主なコンポーネント：

- **カスタムオブジェクト** `Question__c`（問い合わせ）
  - 起票者（Reporter__c）
  - 起票日時（SubmittedDateTime__c）
  - 対応期日（DueDate__c）
  - 優先度（Priority__c：高/中/低）
  - 対象顧客（TargetCustomer__c）
  - 内容（Content__c）
- **Apex クラス** `QuestionController`（レコード作成用）
- **LWC** `question`（問い合わせ起票フォーム）
- **ページレイアウト** `Question Layout`（詳細タブに起票者・起票日時・対応期日・優先度・対象顧客・内容を表示）

### 1-3. デプロイ結果の確認

```bash
sf project deploy start --target-org MySandbox
# 成功時: "Deployed source" と表示される
```

失敗する場合は、エラーメッセージに従ってオブジェクト／Apex／LWC のメタデータを修正してから再デプロイしてください。

---

## 2. Sandbox 内での設定（必要な場合）

### 2-1. 問い合わせタブをアプリに追加する（任意）

1. **設定** → **アプリマネージャ** で対象アプリの **編集** をクリック
2. **ナビゲーション項目** で **問い合わせ一覧**（Question__c）を「選択した項目」に追加
3. **保存** してアプリを開き、タブバーに「問い合わせ」が表示されることを確認

### 2-2. プロファイル／権限セットでオブジェクト権限を付与する

1. **設定** → **プロファイル**（または **権限セット**）→ 対象のプロファイルを開く
2. **オブジェクトの権限** で **問い合わせ** を探す
3. **表示**／**作成**／**編集** など、必要な権限にチェックを入れて **保存**

（作成したユーザーが問い合わせレコードを作成・閲覧できるようにするため）

### 2-3. 詳細タブに項目を表示する（ページレイアウト）

問い合わせレコードの「詳細」タブに、起票者・起票日時・対応期日・優先度・対象顧客・内容を表示するには、ページレイアウトを割り当てます。

1. **設定** → **オブジェクトマネージャ** → **問い合わせ** をクリック
2. 左の **ページレイアウト** をクリック
3. **Question Layout**（デプロイで追加されたレイアウト）をクリックして内容を確認
4. **割り当て**（または「レイアウトの割り当て」）をクリック
5. 対象の **プロファイル** で「Question Layout」を割り当てて **保存**

これで問い合わせの詳細ページに、問い合わせ名・起票者・起票日時・対応期日・優先度・対象顧客・内容・システム情報が表示されます。

### 2-4. LWC を配置するページを決める

問い合わせ起票コンポーネントは、次のいずれかに配置できます。

- **アプリページ**（Lightning アプリのホームなど）
- **レコードページ**（例：取引先のレコードページ）
- **ホームページ**

次の「3. コンポーネントをページに配置する」で実際に配置します。

---

## 3. コンポーネントをページに配置する

### 3-1. アプリビルダーを開く

1. Sandbox にログイン
2. **設定** → **アプリ** → **アプリマネージャ**
3. 編集したい **Lightning アプリ** の **▼** → **編集** をクリック  
   （または **設定** → **ページ** で対象の **Lightning ページ** を開いて編集）

### 3-2. 問い合わせコンポーネントを追加する

1. 左のコンポーネント一覧で **カスタム** を開く
2. **question**（問い合わせ起票）をドラッグして、ページ上の配置したいエリアにドロップ
3. 右上の **保存** → **保存して完了**（または **完了**）でページを保存

### 3-3. 動作確認

1. 該当のアプリ／ページを開く
2. 問い合わせフォームで以下を入力して **保存** をクリック
   - 起票者・対応期日・優先度・対象顧客・内容（起票日時は自動）
3. 「保存しました」のトーストが表示され、フォームがクリアされることを確認
4. **問い合わせ** タブ（または **最近の項目**／**すべて** から「問い合わせ」を検索）で、作成されたレコードが表示されることを確認

---

## 4. トラブルシューティング

| 現象 | 確認すること |
|------|----------------|
| デプロイエラー | `sf project deploy start` のエラー内容を確認。オブジェクト名・API名・必須項目のずれがないか確認 |
| 「保存しました」が出るがレコードが作成されない | **オブジェクト・Apex・LWCの3つをまとめて再デプロイする。** 設定 → オブジェクトマネージャで「問い合わせ」が存在するか確認。存在しなければ `sf project deploy start --target-org <エイリアス>` で再度デプロイ。保存後は作成した問い合わせレコードの詳細ページへ自動遷移するので、遷移しない場合はエラートーストのメッセージを確認する。 |
| プロファイル／権限 | プロファイル／権限セットで問い合わせの「作成」「表示」権限があるか確認 |
| ページにコンポーネントが出てこない | 対象ページの対象タブ（App / Home / Record）が `question.js-meta.xml` の `<targets>` に含まれているか確認 |
| Apex エラー（トーストにメッセージ表示） | デバッグログで `QuestionController.createQuestion` のスタックトレースを確認。日付・日時の形式が想定どおりか確認。「sObject type 'Question__c' is not supported」と出る場合は問い合わせオブジェクトが未デプロイなので、上記の再デプロイを実行する |

---

## 5. 補足：日付・日時の形式

- **起票日時**: LWC から `YYYY-MM-DD HH:mm:ss` 形式で送信。Apex 側で `T` に置換して `DateTime.valueOf()` でパースしています。
- **対応期日**: `YYYY-MM-DD`（`lightning-input type="date"` の値）をそのまま Apex の `Date.valueOf()` に渡しています。

以上で、Sandbox 内で問い合わせレコードをLWCから作成できる状態になります。
